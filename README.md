# php-miio

miIO - проприетарный шифрованный сетевой протокол Xiaomi, по которому взаимодействуют между собой wifi-устройства из экосистемы Xiaomi (Mi Home). Используется транспорт UDP и порт 54321. Ключ шифрования формируется на основе уникального токена, который есть у каждого устройства.

Функционал разделен и описан классами.

`miio.class.php` - класс для сетевого взаимодействия по протоколу miIO:
*	прием udp-пакетов из сокета
*	отправка udp-пакетов в сокет
*	процедура рукопожатия (handshake)
*	отправка сообщений устройству
*	прием ответов от устройства
*	поиск устройств (handshake-discovery)

`mipacket.class.php` - класс для работы с сетевыми udp-пакетами по протоколу miIO:
*	генерация ключа и вектора инициализации из токена
*	расшифровка
*	шифрование
*	парсинг udp-пакета
*	сборка udp-пакета


В качестве примера взаимодействия с устройствами написан скрипт для командной строки `miio-cli.php`.
Принимаемые параметры:
  *	`--discover all`	- поиск устройств в локальной сети и вывод информации о них
  *	`--discover IP`   - проверка доступности конкретного устройства и вывод информации о нем
  *	`--info`	        - получить информацию об устройстве (аналог --discover IP)
  *	`--sendcmd`       - отправить команду (в linux д.б. заключена в одинарные кавычки, в windows без них)
  * `--decode`       -	расшифровать пакет
  *	`--ip`            - IP-адрес устройства
  *	`--bindip`		- IP-адрес интерфейса сервера (не обязательно, если интерфейс один)
  *	`--token`         - токен устройства (не обязательно)
  *	`--debug`         - включает вывод отладочной информации
  *	`--help`          - справка по командам

Примеры:
```php miio-cli.php --discover all
php miio-cli.php --discover all --bindip 192.168.1.10
php miio-cli.php --discover 192.168.1.45 --debug
php miio-cli.php --ip 192.168.1.45 --info
php miio-cli.php --ip 192.168.1.45 --sendcmd '{"method":"toggle",,"params":[],"id":1}'
php miio-cli.php --ip 192.168.1.47 --sendcmd '{"id":1,"method":"get_prop","params":["power"]}'
php miio-cli.php --token b31c928032e6a4afc898c5c8768a518f --decode 2131004000000000035afe...bea030
```

## Описание протокола miIO

### 1. Общие положения
miIO - проприетарный шифрованный сетевой протокол Xiaomi, по которому взаимодействуют wifi-устройства из экосистемы Xiaomi и приложение Mihome на смартфоне. В качествет транспорта используется UDP и порт 54321. Содержимое пакетов шифруется. Для контроля корректности принимаемых пакетов используется контрольная сумма на основе алгоритма MD5.

Данный протокол используется только при взаимодействии в пределах локальной сети! Взаимодействие между устройствами, приложением Mihome и облаком Xiaomi осуществляется по другому протоколу, расшифровать который пока никому не удалось.

### 2. Структура пакета
В протоколе miIO различают два типа пакетов - основной и hello-пакет. Hello-пакет применяется для поиска устройств в сети путем его широковещательной рассылки, либо для начала сессии с конкретным устройством. Для отправки устройству непосредственно команд используется основной пакет.

Пакет формируется из данных в hex-формате, состоит из заголовка (header) и полезной нагрузки (data).

Структура полей пакета приведена на схеме:
![Пакет miIO](img/miIO_пакет.png)

  *	`Magic` - "магическое" число, всегда равно `0х2131` (2 байта).
  *	`Length` - длина пакета в байтах(заголовок+данные) (2 байта).
  *	`Unknown` - поле неизвестного назначения. Всегда заполнено нулями `0х00000000`, а у hello-пакета `0хFFFFFFFF` (4 байта).
  *	`Device type` - тип устройства (2 байта).
  *	`Device ID` - идентификатор устройства (2 байта).
  *	`Time stamp` - временная отметка, время работы устройства в секундах (4 байта).
  *	`Checksum` - контрольная сумма всего пакета по алгоритму MD5. Перед расчетом КС это поле временно заполняется нулями (16 байт).
  *	`Data` - полезная нагрузка произвольной длины - зашифрованные данные, отправляемые устройству. В hello-пакете это поле отсутствует.

В hello-пакете все поля, кроме `Magic` и `Length`, принимают значение `0хFF`.
![Пакет miIO Hello](img/miIO_hello.png)

В особом случае, при ответе на hello-пакет, поле `Checksum` будет содержать 128-битное уникальное значение токена устройства. Это правило всегда актуально для новых, еще не привязанных к wifi устройств. В остальных случаях все зависит от прошивки устройства.

### 3. Сессия
Любое взаимодействие клиента и устройства начинается с "рукопожатия" (handshake). Клиент отправляет hello-пакет устройству и ждет от него ответ. Устройство в ответном пакете (длиной также 32 байта) отправляет свой тип, идентификатор, время работы в секундах и токен (либо нули вместо него). На основе полученных данных клиент формирует основной пакет с зашифрованной командой и отправляет устройству. Получив и выполнив команду от клиента, устройство отправляет ответный пакет с результатом выполнения принятой команды либо с ошибкой ее выполнения.

Процедура "рукопожатия" также используется для поиска устройств в локальной сети (discover). При этом hello-пакет отправляется не на конкретный IP, а на широковещательный адрес сегмента сети. Таким образом hello-пакеты получают все устройства, находящиеся в этом сегменте сети, и соответственно сообщают обратно клиенту о своем существовании.

### 4. Шифрование
Для шифрования отправляемых данных используется симметричный алгоритм шифрование AES128 в режиме CBC. 128-битные ключ шифрования (Key) и вектор инициализации (IV) формируются из уникального токена устройства по следующим формулам:
```
Key = MD5(Token);
IV = MD5(Token+IV);
```

Перед шифрованием необходимо выполнить процедуру дополнения данных `PKCS#7 padding`, а после расшифровки - обратную процедуру.

### 5. Формат команд (api)
Команды, отправляемые устройству и принимаемые от него, представлены в формате JSON.
```
Запрос --> {"id":1,"method":"get_prop","params":["power"]}
Ответ <-- {"id":1,"result":["ok"]}
```
Основные поля - это:
  *	`id` - идентификатор запроса. Его значение не является обязательным для большинства, поэтому можно всегда выставлять равным 1. Но может быть полезен, когда одному и тому же устройству одновременно отправляются команды с разных клиентов. Для некоторых устройств (например, пылесос) данный параметр должен уникальным при каждом запросе.
  *	`method` - метод, действие. Возможные варианты зависят от конкретного устройства, но есть и общие для всех.
  *	`params` - массив свойств, параметров. Возможные варианты зависят от конкретного устройства.
